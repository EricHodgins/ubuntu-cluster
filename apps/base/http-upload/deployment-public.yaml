apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: http-upload
  name: http-uploader
spec:
  replicas: 1
  selector:
    matchLabels:
      app: http-uploader
  template:
    metadata:
      labels:
        app: http-uploader
    spec:
      securityContext:
        fsGroup: 1000

      initContainers:
        - name: volume-permissions
          image: busybox
          command: ['sh', '-c', 'chown -R 1000:1000 /data']
          volumeMounts:
            - name: data
              mountPath: /data

      containers:
        - name: uploader
          image: erichodgins/http-uploader:latest
          ports:
            - containerPort: 8080

          envFrom:
            - secretRef:
                name: upload-token

          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ['ALL']

          volumeMounts:
            - name: data
              mountPath: /data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: drop-pvc
